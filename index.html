<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive CTA Summarizer</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load SheetJS (xlsx) library for Excel and CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Use Inter font family -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Base styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Tailwind gray-100 */
        }
        
        /* New Rollup Section Styles */
        #executive-rollup-content {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb; /* gray-200 */
            page-break-after: avoid;
        }
        .rollup-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .rollup-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .rollup-section {
            background-color: #f9fafb; /* gray-50 */
            border: 1px solid #e5e7eb; /* gray-200 */
            border-radius: 0.5rem; /* 8px */
            padding: 1.25rem;
            overflow-x: auto; /* Allow scrolling on small screens */
        }
        .rollup-section h2 {
            font-size: 1.25rem; /* 20px */
            font-weight: 600;
            color: #111827; /* gray-900 */
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }

        /* --- Table Styles for Rollup --- */
        .rollup-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem; /* 14px */
        }
        .rollup-table th, .rollup-table td {
            padding: 0.75rem 0.5rem; /* 12px 8px */
            text-align: left;
            vertical-align: top;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .rollup-table th {
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            font-size: 0.8rem; /* 13px */
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .rollup-table td {
            color: #374151; /* gray-700 */
        }
        .rollup-table tr:last-child td {
            border-bottom: none;
        }
        
        .rollup-table .th-arr { text-align: right; }
        .rollup-table .th-count { text-align: right; }
 
        .rollup-table .td-rank {
            font-size: 1.125rem;
            font-weight: 700;
            color: #4f46e5; /* indigo-600 */
            vertical-align: middle;
        }
        .rollup-table .td-account, .rollup-table .td-theme {
            font-weight: 500;
            color: #111827; /* gray-900 */
        }
        .rollup-table .td-cta {
            font-size: 0.8rem; /* 13px */
            color: #4b5563; /* gray-600 */
            list-style-type: disc;
            padding-left: 1.25rem;
            margin: 0;
        }
        .rollup-table .td-cta li {
             margin-bottom: 0.25rem;
        }

        .rollup-table .td-arr {
            font-weight: 600;
            color: #c026d3; /* fuchsia-700 */
            text-align: right;
        }
        .rollup-table .td-theme-summary {
            font-size: 0.8rem; /* 13px */
            color: #374151; /* gray-700 */
            line-height: 1.5;
        }
        .rollup-table .td-theme-summary ul {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        .rollup-table .td-theme-summary li {
            padding-left: 0.75rem; /* 12px */
            border-left: 3px solid #e5e7eb; /* gray-200 */
            margin-bottom: 0.5rem; /* 8px */
        }
        .rollup-table .td-theme-summary li strong {
            font-weight: 600;
            color: #111827; /* gray-900 */
            display: block;
        }

        /* Styles for new theme summary list */
        .rollup-table .td-theme-summary-ol {
            list-style-type: decimal;
            padding-left: 1.25rem;
            margin: 0;
        }
        .rollup-table .td-theme-summary-ol > li { /* Account Name */
            margin-bottom: 1rem;
            padding-left: 0.25rem;
        }
        .rollup-table .td-theme-summary-ol > li > ul { /* CTA List */
            list-style-type: disc;
            padding-left: 1.25rem;
            margin-top: 0.5rem;
        }
        .rollup-table .td-theme-summary-ol > li > ul > li { /* CTA Name */
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .rollup-table .td-theme-summary-ol > li > ul > li > ul { /* Details List */
            list-style-type: none; /* No bullets for 'Source' and 'Summary' */
            padding-left: 0.5rem;
            margin-top: 0.25rem;
            border-left: 2px solid #e5e7eb; /* gray-200 */
            font-weight: 400;
        }
        .rollup-table .td-theme-summary-ol > li > ul > li > ul > li { /* Source/Summary li */
            margin-bottom: 0.25rem;
            padding-left: 0.5rem;
        }

        .rollup-table .td-theme-accounts {
            font-size: 0.75rem; /* 12px */
            color: #6b7280; /* gray-500 */
            line-height: 1.5;
            word-break: break-word;
        }
        .rollup-table .td-count {
            font-weight: 600;
            font-size: 1rem;
            color: #111827; /* gray-900 */
            text-align: right;
            vertical-align: middle;
            line-height: 1.4;
        }
        .rollup-table .td-count .count-breakdown {
            display: block;
            font-size: 0.75rem; /* 12px */
            font-weight: 400;
            color: #6b7280; /* gray-500 */
        }

        .rollup-table .total-row {
            background-color: #f9fafb; /* gray-50 */
        }
        .rollup-table .total-row td {
            font-size: 1rem;
            font-weight: 600;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }
        .rollup-table .total-row .total-label {
            text-align: right;
        }
        .rollup-table .total-row .total-value {
            color: #c026d3; /* fuchsia-700 */
            font-size: 1.125rem;
            text-align: right;
        }

        /* Report Item Styles */
        .report-item {
            padding: 0.75rem 0;
            margin-top: 1rem;
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
            page-break-inside: avoid;
        }
        .report-item:first-of-type {
            margin-top: 0;
        }
        .report-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            flex-wrap: wrap; 
        }
        .report-item-title h2 {
            font-size: 1.5rem; /* 24px */
            font-weight: 600;
            color: #111827; /* gray-900 */
            line-height: 1.2;
        }
        .report-item-title h3 {
            font-size: 1.125rem; /* 18px */
            font-weight: 500;
            color: #4b5563; /* gray-600 */
            line-height: 1.2;
        }
        .report-item-metadata {
            list-style-type: none;
            padding: 0;
            margin: 0;
            text-align: right;
            font-size: 0.875rem; /* 14px */
            color: #374151; /* gray-700 */
            line-height: 1.4;
            min-width: 200px;
            padding-left: 1rem;
        }
        .report-item-metadata strong {
            color: #111827; /* gray-900 */
            font-weight: 500;
        }

        .summary-content {
            font-size: 0.875rem; /* 14px */
            padding: 0.75rem 1rem;
            background-color: #f9fafb; /* gray-50 */
            border-radius: 0.375rem; /* 6px */
            border: 1px solid #e5e7eb; /* gray-200 */
        }
        .summary-content h4 {
            font-size: 0.95rem; /* 15px */
            font-weight: 700;
            margin-top: 0.5rem;
            margin-bottom: 0.25rem;
            color: #111827;
        }
        .summary-content h4:first-child {
            margin-top: 0;
        }
        .summary-content ul {
            list-style-type: disc;
            padding-left: 1.25rem;
            margin: 0.25rem 0 0.5rem 0;
        }
        .summary-content li {
             margin-bottom: 0.25rem;
        }
        .summary-content p {
            margin: 0;
        }
        
        .spinner {
            animation: spin 1s linear infinite;
            border-top-color: transparent;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #message-box {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            font-weight: 500;
            z-index: 50;
            transition: bottom 0.5s ease-in-out;
        }
        #message-box.show {
            bottom: 2rem;
        }
        
        @media print {
            body { background-color: #ffffff; font-family: 'Inter', sans-serif; }
            #app-container, #report-header, #cache-loader { display: none; }
            #report-container { display: block; box-shadow: none; margin: 0; padding: 0; max-width: 100%; }
            #report-content { padding: 0; border: none; }
            .rollup-table { font-size: 10pt; page-break-inside: avoid; }
            .rollup-table th, .rollup-table td { padding: 4px 6px; background-color: #ffffff !important; color: #000000 !important; border: 1px solid #dddddd; }
            .rollup-table th { background-color: #f0f0f0 !important; }
            .rollup-section { border: none; padding: 0; background-color: #ffffff !important; }
            .report-item { page-break-inside: avoid; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">Executive CTA Summarizer</h1>
            <p class="mt-2 text-lg text-gray-600">Upload your CTA & Timeline files to generate a focused executive summary of risks, issues, and action items.</p>
        </header>

        <!-- Application UI -->
        <div id="app-container" class="space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700">Step 1: Enter Your API Key</h2>
                <input type="password" id="api-key-input" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Enter your API key here...">
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <h2 class="text-xl font-semibold mb-4 text-indigo-700">Step 2: Select API Model</h2>
                <select id="model-select" class="mt-1 block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm sm:text-sm">
                    <option value="gemini-2.0-flash-lite">Gemini 2.0 Flash Lite (15 RPM)</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash (15 RPM)</option>
                    <option value="gemini-2.5-flash-lite">Gemini 2.5 Flash Lite (4000 RPM)</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash (10 RPM)</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro (2 RPM)</option>
                </select>
                <p id="model-info" class="text-sm text-gray-500 mt-3"></p>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                <div class="flex justify-between items-center cursor-pointer" id="prompts-toggle-btn">
                    <h2 class="text-xl font-semibold text-indigo-700">System Prompts Reference</h2>
                    <span id="prompts-toggle-icon" class="text-gray-500">▼</span>
                </div>
                <div id="prompts-container" class="hidden mt-4 space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">1. Theme Prediction Prompt</label>
                        <textarea id="prompt-theme-prediction" readonly class="w-full h-32 p-2 text-xs font-mono bg-gray-50 border border-gray-300 rounded-md focus:outline-none text-gray-600"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">2. Detailed Summary Prompt</label>
                        <textarea id="prompt-detailed-summary" readonly class="w-full h-32 p-2 text-xs font-mono bg-gray-50 border border-gray-300 rounded-md focus:outline-none text-gray-600"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">3. Rollup Summary Prompt</label>
                        <textarea id="prompt-rollup-summary" readonly class="w-full h-32 p-2 text-xs font-mono bg-gray-50 border border-gray-300 rounded-md focus:outline-none text-gray-600"></textarea>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700">Step 3: Upload Important CTAs</h2>
                    <input type="file" id="cta-file" accept=".csv, .xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <div id="cta-mapping" class="mt-6 space-y-4 hidden">
                        <h3 class="font-semibold text-gray-700">Map CTA Metadata Columns:</h3>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-indigo-700">Step 4: Upload Timeline Entries</h2>
                    <input type="file" id="timeline-file" accept=".csv, .xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <div id="timeline-mapping" class="mt-6 space-y-4 hidden">
                        <h3 class="font-semibold text-gray-700">Map Timeline Data Columns:</h3>
                    </div>
                </div>
            </div>

            <div class="text-center pt-4">
                <button id="generate-btn" disabled class="w-full md:w-1/2 lg:w-1/3 py-3 px-6 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 disabled:bg-gray-400">
                    Generate Report
                </button>
                <button id="clear-settings-btn" class="mt-2 text-sm text-gray-500 hover:text-indigo-600 focus:outline-none">
                    Clear Saved Settings
                </button>
            </div>
        </div>

        <!-- Feedback & Cache -->
        <div id="loader" class="hidden text-center py-12">
            <div class="spinner w-12 h-12 rounded-full border-4 border-indigo-600 border-t-transparent mx-auto"></div>
            <p id="loader-text" class="mt-4 text-lg font-medium text-gray-700">Analyzing...</p>
        </div>

        <div id="cache-loader" class="hidden text-center p-4 bg-yellow-50 border border-yellow-300 rounded-lg shadow-sm">
            <p class="font-medium text-yellow-800">You have a previously generated report.</p>
            <p id="cache-timestamp" class="text-sm text-yellow-700 mb-2"></p>
            <button id="load-cache-btn" class="py-1 px-3 bg-yellow-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-yellow-600">Load Previous Report</button>
            <button id="clear-cache-btn" class="ml-2 py-1 px-3 text-sm text-yellow-700 hover:text-yellow-900">Clear</button>
        </div>

        <!-- Report Container -->
        <div id="report-container" class="bg-white p-6 md:p-10 rounded-lg shadow-xl border border-gray-200 hidden">
            <div id="report-header" class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b border-gray-200 pb-4">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">Generated Executive Summary</h2>
                <div class="flex items-center space-x-4">
                    <button id="copy-btn" class="py-2 px-4 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700">Copy to Clipboard</button>
                    <button id="download-btn" class="py-2 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700">Download HTML</button>
                </div>
            </div>
            <div id="report-content"></div>
        </div>
    </div>

    <div id="message-box" class="bg-green-500 text-white">
        <span id="message-text"></span>
    </div>

    <script type="module">
        const BASE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/`;
        
        const MODEL_CONFIGS = {
            'gemini-2.0-flash-lite': { apiName: 'gemini-2.0-flash-lite', rpm: 15, throttleDelay: 5000, displayName: 'Gemini 2.0 Flash Lite' },
            'gemini-2.0-flash': { apiName: 'gemini-2.0-flash', rpm: 15, throttleDelay: 5000, displayName: 'Gemini 2.0 Flash' },
            'gemini-2.5-flash-lite': { apiName: 'gemini-2.5-flash-lite', rpm: 4000, throttleDelay: 15, displayName: 'Gemini 2.5 Flash Lite' },
            'gemini-2.5-flash': { apiName: 'gemini-2.5-flash', rpm: 10, throttleDelay: 7000, displayName: 'Gemini 2.5 Flash' },
            'gemini-2.5-pro': { apiName: 'gemini-2.5-pro', rpm: 2, throttleDelay: 31000, displayName: 'Gemini 2.5 Pro' }
        };

        const SUMMARY_SYSTEM_PROMPT = `You are an expert business analyst. Your task is to analyze a collection of timeline entries for a customer Call to Action (CTA) and produce a concise summary for an executive audience. Prioritize the most recent entries (those with the latest dates) to reflect the current status. 
Focus EXCLUSIVELY on identifying and extracting:
1. Risks (Current)
2. Issues (Unresolved)
3. Specific Action Items (Pending/Recent)
Respond with "No specific risks, issues, or action items identified." if none found.`;
        
        const THEME_PREDICTION_PROMPT = `You are a risk analyst. Classify the CTA into ONE of: Product Risk, Support Risk, Engagement Risk, Containment Risk, Renewal, Churn, Other Risk. Respond with ONLY the theme name.`;
        
        const THEME_EVIDENCE_SUMMARY_PROMPT = `You are an executive assistant. Summarize ONLY core risks and issues into a single, concise sentence (max 2 sentences). No markdown.`;

        const API_KEY_STORAGE_KEY = 'ctaSummarizerApiKey';
        const MAPPINGS_STORAGE_KEY = 'ctaSummarizerMappings';
        const MODEL_STORAGE_KEY = 'ctaSummarizerModel';
        const REPORT_CACHE_KEY = 'ctaSummarizerLastReport'; 
        const REPORT_CACHE_TIMESTAMP_KEY = 'ctaSummarizerLastReportTimestamp'; 

        const apiKeyInput = document.getElementById('api-key-input');
        const modelSelectEl = document.getElementById('model-select');
        const modelInfoEl = document.getElementById('model-info');
        const ctaFileEl = document.getElementById('cta-file');
        const ctaMappingEl = document.getElementById('cta-mapping');
        const timelineFileEl = document.getElementById('timeline-file');
        const timelineMappingEl = document.getElementById('timeline-mapping');
        const generateBtn = document.getElementById('generate-btn');
        const clearSettingsBtn = document.getElementById('clear-settings-btn');
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
        const reportContainer = document.getElementById('report-container');
        const reportContent = document.getElementById('report-content');
        const copyBtn = document.getElementById('copy-btn');
        const downloadBtn = document.getElementById('download-btn'); 
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const cacheLoaderEl = document.getElementById('cache-loader');
        const cacheTimestampEl = document.getElementById('cache-timestamp');
        const loadCacheBtn = document.getElementById('load-cache-btn');
        const clearCacheBtn = document.getElementById('clear-cache-btn');
        const promptsToggleBtn = document.getElementById('prompts-toggle-btn');
        const promptsContainer = document.getElementById('prompts-container');
        const promptsToggleIcon = document.getElementById('prompts-toggle-icon');
        const promptThemeEl = document.getElementById('prompt-theme-prediction');
        const promptDetailedEl = document.getElementById('prompt-detailed-summary');
        const promptRollupEl = document.getElementById('prompt-rollup-summary');
 
        let ctaHeaders = [];
        let ctaData = [];
        let timelineHeaders = [];
        let timelineData = [];
        let mappings = {
            ctaName: '', companyName: '', csmName: '', fieldCtoName: '', 
            accountOwnerName: '', ctaCreatedDate: '', ctaAge: '', ctaPriority: '', 
            renewalDate: '', arr: '', riskTheme: '', timelineCtaName: '', 
            timelineNote: '', timelineActivityDate: ''
        };
        
        const requiredMappings = [
            'ctaName', 'companyName', 'csmName', 'fieldCtoName', 'accountOwnerName', 
            'ctaCreatedDate', 'ctaAge', 'ctaPriority', 'renewalDate', 'arr', 
            'riskTheme', 'timelineCtaName', 'timelineNote', 'timelineActivityDate'
        ];

        let rankedThreats = [];
        let themeAggregates = {};
        let renewalRisk = {};
        let ctaReportData = [];
        let ctaDataWithThemes = []; 

        function loadSettings() {
            try {
                const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
                if (savedApiKey) apiKeyInput.value = savedApiKey;
                const savedModel = localStorage.getItem(MODEL_STORAGE_KEY);
                if (savedModel && MODEL_CONFIGS[savedModel]) modelSelectEl.value = savedModel;
                updateModelInfo();
                const savedMappings = localStorage.getItem(MAPPINGS_STORAGE_KEY);
                if (savedMappings) {
                    const parsedMappings = JSON.parse(savedMappings);
                    mappings = { ...mappings, ...parsedMappings };
                }
                const cachedReport = localStorage.getItem(REPORT_CACHE_KEY);
                const cachedTimestamp = localStorage.getItem(REPORT_CACHE_TIMESTAMP_KEY);
                if (cachedReport && cachedTimestamp) {
                    const date = new Date(cachedTimestamp);
                    cacheTimestampEl.textContent = `Generated on: ${date.toLocaleString()}`;
                    cacheLoaderEl.classList.remove('hidden');
                }
            } catch (e) {}
            checkGenerateButtonState();
            promptThemeEl.value = THEME_PREDICTION_PROMPT;
            promptDetailedEl.value = SUMMARY_SYSTEM_PROMPT;
            promptRollupEl.value = THEME_EVIDENCE_SUMMARY_PROMPT;
        }

        // --- NEW: Restore missing cache functions ---
        function loadCachedReport() {
            try {
                const cachedReport = localStorage.getItem(REPORT_CACHE_KEY);
                if (cachedReport) {
                    reportContent.innerHTML = cachedReport;
                    reportContainer.classList.remove('hidden');
                    cacheLoaderEl.classList.add('hidden');
                    showMessage('Loaded previous report.', false);
                    downloadBtn.disabled = false;
                    copyBtn.disabled = false;
                }
            } catch (error) {
                showMessage('Failed to load cached report.', true);
            }
        }
        
        function clearCachedReport() {
            localStorage.removeItem(REPORT_CACHE_KEY);
            localStorage.removeItem(REPORT_CACHE_TIMESTAMP_KEY);
            cacheLoaderEl.classList.add('hidden');
            showMessage('Cleared cached report.', false);
        }

        function updateModelInfo() {
            const modelConfig = MODEL_CONFIGS[modelSelectEl.value];
            if (!modelConfig) return;
            const ctaCount = ctaData.length;
            let infoText = `Requests/min: ${modelConfig.rpm}.`;
            if (ctaCount > 0) {
                const totalSeconds = (ctaCount * 3 * modelConfig.throttleDelay) / 1000;
                infoText += ` Estimated: ${Math.ceil(totalSeconds/60)} minute(s).`;
            }
            modelInfoEl.textContent = infoText;
            checkGenerateButtonState();
        }

        function parseFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const dataObjects = XLSX.utils.sheet_to_json(sheet, { cellDates: true, defval: "" });
                        if (dataObjects.length === 0) return reject(new Error('Empty file.'));
                        resolve({ headers: Object.keys(dataObjects[0]), data: dataObjects });
                    } catch (err) { reject(err); }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        async function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            loaderText.textContent = `Parsing ${file.name}...`;
            loader.classList.remove('hidden');
            try {
                const { headers, data } = await parseFile(file);
                if (type === 'cta') { ctaHeaders = headers; ctaData = data; renderMappingUI('cta', headers); updateModelInfo(); }
                else { timelineHeaders = headers; timelineData = data; renderMappingUI('timeline', headers); }
            } catch (e) { showMessage(e.message, true); }
            finally { loader.classList.add('hidden'); checkGenerateButtonState(); }
        }

        function renderMappingUI(type, headers) {
            let container, fields;
            if (type === 'cta') {
                container = ctaMappingEl;
                fields = [
                    { key: 'ctaName', label: 'CTA Name' }, { key: 'companyName', label: 'Company' },
                    { key: 'csmName', label: 'CSM Name' }, { key: 'fieldCtoName', label: 'Field CTO' },
                    { key: 'accountOwnerName', label: 'Account Owner' }, { key: 'ctaCreatedDate', label: 'Created Date' },
                    { key: 'ctaAge', label: 'Age' }, { key: 'ctaPriority', label: 'Priority' },
                    { key: 'renewalDate', label: 'Renewal Date' }, { key: 'arr', label: 'ARR' },
                    { key: 'riskTheme', label: 'Risk Theme / Reason' }
                ];
            } else {
                container = timelineMappingEl;
                fields = [{ key: 'timelineCtaName', label: 'CTA Name' }, { key: 'timelineNote', label: 'Note' }, { key: 'timelineActivityDate', label: 'Activity Date' }];
            }
            container.innerHTML = '';
            fields.forEach(f => {
                const wrap = document.createElement('div');
                wrap.innerHTML = `<label class="block text-sm font-medium text-gray-700">${f.label}</label><select id="${f.key}" class="mt-1 block w-full py-2 border rounded-md sm:text-sm"><option value="">Select...</option>${headers.map(h => `<option value="${h}">${h}</option>`).join('')}</select>`;
                const sel = wrap.querySelector('select');
                if (mappings[f.key] && headers.includes(mappings[f.key])) sel.value = mappings[f.key];
                sel.addEventListener('change', e => { mappings[f.key] = e.target.value; localStorage.setItem(MAPPINGS_STORAGE_KEY, JSON.stringify(mappings)); checkGenerateButtonState(); });
                container.appendChild(wrap);
            });
            container.classList.remove('hidden');
        }

        function checkGenerateButtonState() {
            const valid = requiredMappings.every(k => mappings[k]) && apiKeyInput.value.trim() && modelSelectEl.value && ctaData.length && timelineData.length;
            generateBtn.disabled = !valid;
        }

        /**
         * UPDATED: Fixed date parsing for Excel Serial numbers (e.g. 46112)
         */
        function parseRobustDate(dateVal) {
            if (dateVal instanceof Date) return dateVal;
            if (dateVal === null || dateVal === undefined || dateVal === "") return null;
            
            let str = String(dateVal).split('[cite')[0].trim();
            
            // Fix for numeric strings from Excel (e.g. "46112")
            if (/^\d+(\.\d+)?$/.test(str)) {
                const num = parseFloat(str);
                if (num > 3000 && num < 100000) { 
                    return new Date(Math.round((num - 25569) * 86400 * 1000));
                }
            }

            let d = new Date(str);
            // If year is impossible (e.g. 46112) or browser failed on hyphens, try normalization
            if (isNaN(d.getTime()) || d.getFullYear() > 3000) {
                const normalized = str.replace(/-/g, "/");
                const d2 = new Date(normalized);
                if (!isNaN(d2.getTime()) && d2.getFullYear() < 3000) return d2;
            }

            return (isNaN(d.getTime()) || d.getFullYear() > 3000) ? null : d;
        }

        function parseARR(s) {
            if (typeof s === 'number') return s;
            return parseFloat(String(s).replace(/[^0-9.-]+/g, "")) || 0;
        }
        
        const curFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 });

        async function determineAllThemes(timelineMap, apiKey, modelConfig) {
            const TARGETS = ['Product Risk', 'Support Risk', 'Engagement Risk', 'Containment Risk', 'Renewal', 'Churn', 'Other Risk'];
            const res = [];
            for (let i = 0; i < ctaData.length; i++) {
                const row = ctaData[i];
                const ctaName = row[mappings.ctaName];
                loaderText.textContent = `[Step 1/2] Classifying theme ${i + 1} of ${ctaData.length}...`;

                const reason = String(row[mappings.riskTheme] || '').trim();
                const match = TARGETS.find(t => t.toLowerCase() === reason.toLowerCase());

                if (match) {
                    res.push({ ...row, predictedTheme: match, themeSource: 'Reason' });
                } else {
                    const notes = (timelineMap.get(ctaName) || []).filter(n => n.date >= new Date(Date.now() - 60*86400000)).map(n => `[${n.date.toLocaleDateString()}]: ${n.note}`).join('\n');
                    try {
                        const theme = await callGeminiAPI(`CTA: ${ctaName}\nNotes:\n${notes || 'No notes'}`, apiKey, modelConfig.apiName, THEME_PREDICTION_PROMPT);
                        const clean = theme.trim().replace(/\*\*/g, '');
                        res.push({ ...row, predictedTheme: TARGETS.includes(clean) ? clean : 'Other Risk', themeSource: 'Predicted' });
                    } catch (e) {
                        res.push({ ...row, predictedTheme: 'Other Risk', themeSource: 'Predicted' });
                    }
                    await new Promise(r => setTimeout(r, modelConfig.throttleDelay));
                }
            }
            return res;
        }

        async function generateReport() {
            const apiKey = apiKeyInput.value.trim();
            const modelConfig = MODEL_CONFIGS[modelSelectEl.value];
            loader.classList.remove('hidden');
            reportContainer.classList.add('hidden');
            reportContent.innerHTML = '';
            
            try {
                const timelineMap = new Map();
                timelineData.forEach(row => {
                    const d = parseRobustDate(row[mappings.timelineActivityDate]);
                    if (row[mappings.timelineCtaName] && row[mappings.timelineNote] && d) {
                        if (!timelineMap.has(row[mappings.timelineCtaName])) timelineMap.set(row[mappings.timelineCtaName], []);
                        timelineMap.get(row[mappings.timelineCtaName]).push({ note: row[mappings.timelineNote], date: d });
                    }
                });
                for (let arr of timelineMap.values()) arr.sort((a,b) => a.date - b.date);

                ctaDataWithThemes = await determineAllThemes(timelineMap, apiKey, modelConfig);
                
                themeAggregates = {};
                ctaDataWithThemes.forEach(row => {
                    const t = row.predictedTheme;
                    if (!themeAggregates[t]) themeAggregates[t] = { count: 0, companies: [], reasonCount: 0, predictedCount: 0 };
                    themeAggregates[t].count++;
                    themeAggregates[t].companies.push(row[mappings.companyName] || 'N/A');
                    if (row.themeSource === 'Reason') themeAggregates[t].reasonCount++; else themeAggregates[t].predictedCount++;
                });

                renewalRisk = calculateRenewalRisk(ctaDataWithThemes);
                rankedThreats = calculateThreatRanking(ctaData);

                ctaReportData = [];
                for (let i = 0; i < ctaDataWithThemes.length; i++) {
                    const row = ctaDataWithThemes[i];
                    loaderText.textContent = `[Step 2/2] Summarizing ${i + 1} of ${ctaDataWithThemes.length}...`;
                    const notes = (timelineMap.get(row[mappings.ctaName]) || []).filter(n => n.date >= new Date(Date.now() - 60*86400000));
                    const context = notes.map(n => `[${n.date.toLocaleDateString()}]: ${n.note}`).join('\n');
                    
                    const metadata = {
                        company: row[mappings.companyName] || 'N/A', csm: row[mappings.csmName] || 'N/A',
                        fieldCto: row[mappings.fieldCtoName] || 'N/A', accountOwner: row[mappings.accountOwnerName] || 'N/A',
                        priority: row[mappings.ctaPriority] || 'N/A', age: row[mappings.ctaAge] || 'N/A',
                        renewal: parseRobustDate(row[mappings.renewalDate])?.toLocaleDateString() || 'N/A',
                        arr: curFmt.format(parseARR(row[mappings.arr]))
                    };

                    let detail = "No recent entries.", brief = "No recent entries.";
                    if (context) {
                        detail = await callGeminiAPI(context, apiKey, modelConfig.apiName, SUMMARY_SYSTEM_PROMPT);
                        brief = await callGeminiAPI(detail, apiKey, modelConfig.apiName, THEME_EVIDENCE_SUMMARY_PROMPT);
                    }
                    row.themeAlignedSummary = brief;
                    ctaReportData.push({ ctaName: row[mappings.ctaName], metadata, summary: detail });
                    await new Promise(r => setTimeout(r, modelConfig.throttleDelay));
                }
                
                renderExecutiveRollup(themeAggregates, renewalRisk, rankedThreats, ctaDataWithThemes);
                renderDetailedReport(ctaReportData);
                
                localStorage.setItem(REPORT_CACHE_KEY, reportContent.innerHTML);
                localStorage.setItem(REPORT_CACHE_TIMESTAMP_KEY, new Date().toISOString());
                reportContainer.classList.remove('hidden');
                copyBtn.disabled = false; downloadBtn.disabled = false;
            } catch (e) { showMessage(e.message, true); }
            finally { loader.classList.add('hidden'); generateBtn.disabled = false; }
        }

        async function callGeminiAPI(text, apiKey, model, systemPrompt) {
            const url = `${BASE_API_URL}${model}:generateContent?key=${apiKey}`;
            const r = await fetch(url, { method: 'POST', body: JSON.stringify({ contents: [{ parts: [{ text }] }], systemInstruction: { parts: [{ text: systemPrompt }] } }) });
            if (!r.ok) throw new Error(await r.text());
            const j = await r.json();
            return j.candidates[0].content.parts[0].text;
        }

        function calculateRenewalRisk(data) {
            const res = { nearTermTotalArr: 0, nearTermClients: [], midTermTotalArr: 0, midTermClients: [] };
            const ninety = new Date(Date.now() + 90 * 86400000);
            const oneEighty = new Date(Date.now() + 180 * 86400000);
            const accs = new Map();
            data.forEach(row => {
                const rd = parseRobustDate(row[mappings.renewalDate]);
                if (!rd || rd > oneEighty) return;
                const co = row[mappings.companyName];
                if (!accs.has(co)) accs.set(co, { name: co, arr: parseARR(row[mappings.arr]), rd, ctas: [] });
                accs.get(co).ctas.push(row[mappings.ctaName]);
            });
            accs.forEach(a => {
                const item = { name: a.name, arrFormatted: curFmt.format(a.arr), renewalDateFormatted: a.rd.toLocaleDateString(), ctaNames: a.ctas, arr: a.arr };
                if (a.rd < ninety) { res.nearTermTotalArr += a.arr; res.nearTermClients.push(item); }
                else { res.midTermTotalArr += a.arr; res.midTermClients.push(item); }
            });
            res.nearTermTotalArrFormatted = curFmt.format(res.nearTermTotalArr);
            res.midTermTotalArrFormatted = curFmt.format(res.midTermTotalArr);
            return res;
        }

        function calculateThreatRanking(ctaData) {
            const now = new Date();
            const accountMap = new Map();
            let maxArr = 0, maxAge = 0;
            ctaData.forEach(row => {
                const co = row[mappings.companyName] || 'N/A';
                const arr = parseARR(row[mappings.arr]);
                const age = parseFloat(row[mappings.ctaAge]) || 0;
                if (arr > maxArr) maxArr = arr;
                if (age > maxAge) maxAge = age;
                if (!accountMap.has(co)) accountMap.set(co, { companyName: co, arr, arrFormatted: curFmt.format(arr), ctas: [] });
                accountMap.get(co).ctas.push({ ctaName: row[mappings.ctaName], age, priority: row[mappings.ctaPriority], renewalDate: row[mappings.renewalDate] });
            });
            const res = [];
            for (const a of accountMap.values()) {
                let soonest = new Date('2999-12-31'), highP = 'Low', oldA = 0;
                a.ctas.forEach(c => {
                    if (c.age > oldA) oldA = c.age;
                    const p = String(c.priority).toLowerCase();
                    if (p === 'high') highP = 'High'; else if (p === 'medium' && highP !== 'High') highP = 'Medium';
                    const rd = parseRobustDate(c.renewalDate);
                    if (rd && rd < soonest) soonest = rd;
                });
                const valid = soonest.getFullYear() !== 2999;
                const days = valid ? (soonest - now) / 86400000 : Infinity;
                if (days > 365) continue;
                let rS = valid ? (days < 0 ? 1.0 : (days <= 90 ? 1.0 - (days/90)*0.5 : 0.5 - ((days-90)/275)*0.5)) : 0;
                const score = (rS * 0.40) + ((maxArr ? a.arr/maxArr : 0) * 0.30) + ((highP === 'High' ? 1.0 : (highP === 'Medium' ? 0.6 : 0.2)) * 0.20) + ((maxAge ? oldA/maxAge : 0) * 0.10);
                res.push({ ...a, finalScore: score, age: oldA, priorityRaw: highP, ctaNames: a.ctas.map(c => c.ctaName), renewalDateFormatted: valid ? soonest.toLocaleDateString() : 'N/A' });
            }
            return res.sort((a,b) => b.finalScore - a.finalScore);
        }

        /**
         * UPDATED: Restored complex nested evidence list structure
         */
        function renderExecutiveRollup(themes, renewal, threats, data) {
            let threatRows = threats.slice(0, 10).map((t, i) => `<tr><td class="td-rank">#${i+1}</td><td class="td-account">${t.companyName}</td><td>${t.ctaNames.length > 1 ? `<ul class="td-cta">${t.ctaNames.map(n=>`<li>${n}</li>`).join('')}</ul>` : t.ctaNames[0]}</td><td class="td-arr">${t.arrFormatted}</td><td>${t.renewalDateFormatted}</td><td>${t.age}</td><td>${t.priorityRaw}</td></tr>`).join('');
            
            let themeRows = Object.entries(themes).sort((a,b) => b[1].count - a[1].count).map(([t, v]) => {
                const accountsForTheme = new Map();
                data.filter(d => d.predictedTheme === t).forEach(d => {
                    const co = d[mappings.companyName] || 'N/A';
                    if (!accountsForTheme.has(co)) accountsForTheme.set(co, []);
                    accountsForTheme.get(co).push(d);
                });
                
                let evidenceHtml = '<ol class="td-theme-summary-ol">';
                [...accountsForTheme.entries()].sort((a,b) => a[0].localeCompare(b[0])).forEach(([acc, ctas]) => {
                    evidenceHtml += `<li><strong>${acc}</strong><ul>`;
                    ctas.forEach(c => {
                        evidenceHtml += `<li>${c[mappings.ctaName]}<ul><li><strong>Source:</strong> ${c.themeSource}</li><li>${c.themeAlignedSummary}</li></ul></li>`;
                    });
                    evidenceHtml += '</ul></li>';
                });
                evidenceHtml += '</ol>';

                return `<tr><td class="td-theme">${t}</td><td class="td-theme-summary">${evidenceHtml}</td><td class="td-theme-accounts">${[...new Set(v.companies)].join(', ')}</td><td class="td-count">${v.count}<span class="count-breakdown">(${v.reasonCount} Reason, ${v.predictedCount} Predicted)</span></td></tr>`;
            }).join('');

            const wrap = (h, c) => `<div class="rollup-section"><h2>${h}</h2>${c}</div>`;
            
            reportContent.innerHTML = `
                <div id="executive-rollup-content">
                    <h1 class="text-3xl font-bold mb-4">Executive Roll-up</h1>
                    <div class="rollup-section mb-6"><h2>Top Renewal Threat Ranking</h2><table class="rollup-table"><thead><tr><th class="th-rank">Rank</th><th>Account</th><th>CTA(s)</th><th class="th-arr">ARR</th><th>Renews</th><th>Max Age</th><th>Max Priority</th></tr></thead><tbody>${threatRows}</tbody></table></div>
                    <div class="rollup-section mb-6"><h2>Risk Theme Analysis</h2><table class="rollup-table"><thead><tr><th class="th-theme">Theme</th><th>Account-Specific Evidence</th><th class="th-accounts">All Accounts</th><th class="th-count">Total</th></tr></thead><tbody>${themeRows}</tbody></table></div>
                    <div class="rollup-grid mt-6">
                        <div class="rollup-section"><h2>Risk Accounts with Upcoming Renewals (0-90 Days)</h2><table class="rollup-table"><thead><tr><th>Account</th><th>ARR</th></tr></thead><tbody>${renewal.nearTermClients.map(c=>`<tr><td>${c.name}</td><td class="td-arr">${c.arrFormatted}</td></tr>`).join('')}<tr class="total-row"><td class="total-label">Total Near-Term Risk:</td><td class="total-value">${renewal.nearTermTotalArrFormatted}</td></tr></tbody></table></div>
                        <div class="rollup-section"><h2>Risk Accounts with Upcoming Renewals (91-180 Days)</h2><table class="rollup-table"><thead><tr><th>Account</th><th>ARR</th></tr></thead><tbody>${renewal.midTermClients.map(c=>`<tr><td>${c.name}</td><td class="td-arr">${c.arrFormatted}</td></tr>`).join('')}<tr class="total-row"><td class="total-label">Total Mid-Term Risk:</td><td class="total-value">${renewal.midTermTotalArrFormatted}</td></tr></tbody></table></div>
                    </div>
                </div>
            `;
        }

        /**
         * UPDATED: Fully restored all 7 metadata points in the detailed summaries
         */
        function renderDetailedReport(data) {
            let html = `<h1 class="text-3xl font-bold mt-8">Detailed CTA Summaries</h1>`;
            data.sort((a,b) => a.metadata.company.localeCompare(b.metadata.company)).forEach(item => {
                const s = item.summary.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/(Risks|Issues|Action Items):/g, '<h4>$1:</h4>').replace(/\* (.*)/g, '<li>$1</li>').replace(/(<li>.*<\/li>(\n<li>.*<\/li>)*)/g, '<ul>$1</ul>').replace(/\n/g, '');
                html += `<div class="report-item">
                    <div class="report-item-header">
                        <div class="report-item-title"><h2>${item.metadata.company}</h2><h3>${item.ctaName}</h3></div>
                        <ul class="report-item-metadata">
                            <li><strong>CSM:</strong> ${item.metadata.csm}</li>
                            <li><strong>Field CTO:</strong> ${item.metadata.fieldCto}</li>
                            <li><strong>Account Owner:</strong> ${item.metadata.accountOwner}</li>
                            <li><strong>Priority:</strong> ${item.metadata.priority}</li>
                            <li><strong>Age:</strong> ${item.metadata.age} days</li>
                            <li><strong>Renewal:</strong> ${item.metadata.renewal}</li>
                            <li><strong>ARR:</strong> ${item.metadata.arr}</li>
                        </ul>
                    </div>
                    <div class="summary-content">${s}</div>
                </div>`;
            });
            reportContent.innerHTML += html;
        }

        function copyReportToClipboard() {
            const range = document.createRange(); range.selectNode(reportContent);
            window.getSelection().removeAllRanges(); window.getSelection().addRange(range);
            document.execCommand('copy'); window.getSelection().removeAllRanges();
            showMessage('Copied to clipboard!');
        }

        function downloadReportAsHTML() {
            const fullHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><script src="https://cdn.tailwindcss.com"><\/script><style>${document.querySelector('style').innerHTML}</style></head><body class="bg-gray-100 p-8"><div class="max-w-7xl mx-auto bg-white p-10 rounded-lg shadow-xl">${reportContent.innerHTML}</div></body></html>`;
            const blob = new Blob([fullHtml], { type: 'text/html' });
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `CTA_Executive_Summary.html`; a.click();
        }

        document.addEventListener('DOMContentLoaded', loadSettings);
        apiKeyInput.addEventListener('input', e => localStorage.setItem(API_KEY_STORAGE_KEY, e.target.value));
        modelSelectEl.addEventListener('input', updateModelInfo);
        ctaFileEl.addEventListener('change', e => handleFileUpload(e, 'cta'));
        timelineFileEl.addEventListener('change', e => handleFileUpload(e, 'timeline'));
        generateBtn.addEventListener('click', generateReport);
        copyBtn.addEventListener('click', copyReportToClipboard);
        downloadBtn.addEventListener('click', downloadReportAsHTML);
        clearSettingsBtn.addEventListener('click', () => { localStorage.clear(); location.reload(); });
        loadCacheBtn.addEventListener('click', loadCachedReport);
        clearCacheBtn.addEventListener('click', clearCachedReport);
        promptsToggleBtn.addEventListener('click', () => { promptsContainer.classList.toggle('hidden'); promptsToggleIcon.textContent = promptsContainer.classList.contains('hidden') ? '▼' : '▲'; });

        function showMessage(m, err = false) {
            messageText.textContent = m; messageBox.className = err ? 'bg-red-500 text-white fixed show' : 'bg-green-500 text-white fixed show';
            setTimeout(() => messageBox.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
